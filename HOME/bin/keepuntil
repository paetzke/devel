#!/bin/bash -eu


source_config() {
    source ~/.config/keepuntil

    test -d "$KEEPUNTIL_GRAVEYARD"
    test -d "$KEEPUNTIL_ROOT"
}


die() {
    local msg="$1"

    echo $msg
    exit 1
}


get_absolute_path() {
    local path="$1"

    pushd $(dirname $path) > /dev/null
    echo $(pwd)
    popd > /dev/null
}


compress_folder() {
    local path="$1"
    local date="$2"
    local compress_name

    compress_name=${path/\//}
    compress_name=${compress_name//\//\--}
    compress_name="$KEEPUNTIL_GRAVEYARD$date-$compress_name.tar.gz"

    if [ -f "$compress_name" ]; then
        die "$compress_name already exists."
    fi

    pushd $path > /dev/null
    echo $compress_name
    tar czvf $compress_name * > /dev/null
    chmod 444 $compress_name
    popd > /dev/null
    rm -rf $path
}


main() {
    local filename
    local content
    local now=$(date +%s)
    local keepuntil

    source_config

    for filename in $(find $KEEPUNTIL_ROOT -name .keepuntil 2> /dev/null); do
        echo "FOUND $(dirname $filename)"

        content=$(cat $filename)
        keepuntil=$(date -j -f "%Y-%m-%d" $content "+%s")
        echo -e "\tvalid until $content"

        if [[ $now > $keepuntil ]]; then
            echo -e "\tMOVING"
            compress_folder $(get_absolute_path $filename) "$content"
        fi
    done
}


main
